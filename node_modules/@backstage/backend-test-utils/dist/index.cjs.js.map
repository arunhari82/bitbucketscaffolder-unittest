{"version":3,"file":"index.cjs.js","sources":["../src/util/isDockerDisabledForTests.ts","../src/database/startMysqlContainer.ts","../src/database/startPostgresContainer.ts","../src/util/getDockerImageForName.ts","../src/database/types.ts","../src/database/TestDatabases.ts","../src/msw/setupRequestMockHandlers.ts","../src/filesystem/MockDirectory.ts","../src/next/services/MockIdentityService.ts","../src/next/services/MockRootLoggerService.ts","../src/next/services/mockCredentials.ts","../src/next/services/MockAuthService.ts","../src/next/services/MockHttpAuthService.ts","../src/next/services/MockUserInfoService.ts","../src/next/services/mockServices.ts","../src/next/wiring/TestBackend.ts","../../backend-app-api/src/lib/DependencyGraph.ts","../../backend-app-api/src/wiring/ServiceRegistry.ts","../src/next/wiring/ServiceFactoryTester.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @public */\nexport function isDockerDisabledForTests() {\n  // If we are not running in continuous integration, the default is to skip\n  // the (relatively heavy, long running) docker based tests. If you want to\n  // still run local tests for all databases, just pass either the CI=1 env\n  // parameter to your test runner, or individual connection strings per\n  // database.\n  return (\n    Boolean(process.env.BACKSTAGE_TEST_DISABLE_DOCKER) ||\n    !Boolean(process.env.CI)\n  );\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport createConnection, { Knex } from 'knex';\nimport { v4 as uuid } from 'uuid';\n\nasync function waitForMysqlReady(\n  connection: Knex.MySqlConnectionConfig,\n): Promise<void> {\n  const startTime = Date.now();\n  const db = createConnection({ client: 'mysql2', connection });\n\n  try {\n    for (;;) {\n      try {\n        const result = await db.select(db.raw('version() AS version'));\n        if (result[0]?.version) {\n          return;\n        }\n      } catch (e) {\n        if (Date.now() - startTime > 30_000) {\n          throw new Error(\n            `Timed out waiting for the database to be ready for connections, ${e}`,\n          );\n        }\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 100));\n    }\n  } finally {\n    db.destroy();\n  }\n}\n\nexport async function startMysqlContainer(image: string) {\n  const user = 'root';\n  const password = uuid();\n\n  // Lazy-load to avoid side-effect of importing testcontainers\n  const { GenericContainer } = await import('testcontainers');\n\n  const container = await new GenericContainer(image)\n    .withExposedPorts(3306)\n    .withEnvironment({ MYSQL_ROOT_PASSWORD: password })\n    .withTmpFs({ '/var/lib/mysql': 'rw' })\n    .start();\n\n  const host = container.getHost();\n  const port = container.getMappedPort(3306);\n  const stop = async () => {\n    await container.stop({ timeout: 10_000 });\n  };\n\n  await waitForMysqlReady({ host, port, user, password });\n\n  return { host, port, user, password, stop };\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport createConnection, { Knex } from 'knex';\nimport { v4 as uuid } from 'uuid';\n\nasync function waitForPostgresReady(\n  connection: Knex.PgConnectionConfig,\n): Promise<void> {\n  const startTime = Date.now();\n  const db = createConnection({ client: 'pg', connection });\n\n  try {\n    for (;;) {\n      try {\n        const result = await db.select(db.raw('version()'));\n        if (Array.isArray(result) && result[0]?.version) {\n          return;\n        }\n      } catch (e) {\n        if (Date.now() - startTime > 30_000) {\n          throw new Error(\n            `Timed out waiting for the database to be ready for connections, ${e}`,\n          );\n        }\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 100));\n    }\n  } finally {\n    db.destroy();\n  }\n}\n\nexport async function startPostgresContainer(image: string) {\n  const user = 'postgres';\n  const password = uuid();\n\n  // Lazy-load to avoid side-effect of importing testcontainers\n  const { GenericContainer } = await import('testcontainers');\n\n  const container = await new GenericContainer(image)\n    .withExposedPorts(5432)\n    .withEnvironment({ POSTGRES_PASSWORD: password })\n    .withTmpFs({ '/var/lib/postgresql/data': 'rw' })\n    .start();\n\n  const host = container.getHost();\n  const port = container.getMappedPort(5432);\n  const stop = async () => {\n    await container.stop({ timeout: 10_000 });\n  };\n\n  await waitForPostgresReady({ host, port, user, password });\n\n  return { host, port, user, password, stop };\n}\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const getDockerImageForName = (name: string) => {\n  return process.env.BACKSTAGE_TEST_DOCKER_REGISTRY\n    ? `${process.env.BACKSTAGE_TEST_DOCKER_REGISTRY}/${name}`\n    : name;\n};\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DatabaseManager } from '@backstage/backend-common';\nimport { Knex } from 'knex';\nimport { getDockerImageForName } from '../util/getDockerImageForName';\n\n/**\n * The possible databases to test against.\n *\n * @public\n */\nexport type TestDatabaseId =\n  | 'POSTGRES_16'\n  | 'POSTGRES_15'\n  | 'POSTGRES_14'\n  | 'POSTGRES_13'\n  | 'POSTGRES_12'\n  | 'POSTGRES_11'\n  | 'POSTGRES_9'\n  | 'MYSQL_8'\n  | 'SQLITE_3';\n\nexport type TestDatabaseProperties = {\n  name: string;\n  driver: string;\n  dockerImageName?: string;\n  connectionStringEnvironmentVariableName?: string;\n};\n\nexport type Instance = {\n  stopContainer?: () => Promise<void>;\n  dropDatabases?: () => Promise<void>;\n  databaseManager: DatabaseManager;\n  connections: Array<Knex>;\n  databaseNames: Array<string>;\n};\n\nexport const allDatabases: Record<TestDatabaseId, TestDatabaseProperties> =\n  Object.freeze({\n    POSTGRES_16: {\n      name: 'Postgres 16.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:16'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES16_CONNECTION_STRING',\n    },\n    POSTGRES_15: {\n      name: 'Postgres 15.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:15'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES15_CONNECTION_STRING',\n    },\n    POSTGRES_14: {\n      name: 'Postgres 14.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:14'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES14_CONNECTION_STRING',\n    },\n    POSTGRES_13: {\n      name: 'Postgres 13.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:13'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES13_CONNECTION_STRING',\n    },\n    POSTGRES_12: {\n      name: 'Postgres 12.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:12'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES12_CONNECTION_STRING',\n    },\n    POSTGRES_11: {\n      name: 'Postgres 11.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:11'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES11_CONNECTION_STRING',\n    },\n    POSTGRES_9: {\n      name: 'Postgres 9.x',\n      driver: 'pg',\n      dockerImageName: getDockerImageForName('postgres:9'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_POSTGRES9_CONNECTION_STRING',\n    },\n    MYSQL_8: {\n      name: 'MySQL 8.x',\n      driver: 'mysql2',\n      dockerImageName: getDockerImageForName('mysql:8'),\n      connectionStringEnvironmentVariableName:\n        'BACKSTAGE_TEST_DATABASE_MYSQL8_CONNECTION_STRING',\n    },\n    SQLITE_3: {\n      name: 'SQLite 3.x',\n      driver: 'better-sqlite3',\n    },\n  });\n","/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DatabaseManager, dropDatabase } from '@backstage/backend-common';\nimport { ConfigReader } from '@backstage/config';\nimport { randomBytes } from 'crypto';\nimport { Knex } from 'knex';\nimport { isDockerDisabledForTests } from '../util/isDockerDisabledForTests';\nimport { startMysqlContainer } from './startMysqlContainer';\nimport { startPostgresContainer } from './startPostgresContainer';\nimport {\n  allDatabases,\n  Instance,\n  TestDatabaseId,\n  TestDatabaseProperties,\n} from './types';\n\nconst LARGER_POOL_CONFIG = {\n  pool: {\n    min: 0,\n    max: 50,\n  },\n};\n\n/**\n * Encapsulates the creation of ephemeral test database instances for use\n * inside unit or integration tests.\n *\n * @public\n */\nexport class TestDatabases {\n  private readonly instanceById: Map<string, Instance>;\n  private readonly supportedIds: TestDatabaseId[];\n  private static defaultIds?: TestDatabaseId[];\n\n  /**\n   * Creates an empty `TestDatabases` instance, and sets up Jest to clean up\n   * all of its acquired resources after all tests finish.\n   *\n   * You typically want to create just a single instance like this at the top\n   * of your test file or `describe` block, and then call `init` many times on\n   * that instance inside the individual tests. Spinning up a \"physical\"\n   * database instance takes a considerable amount of time, slowing down tests.\n   * But initializing a new logical database inside that instance using `init`\n   * is very fast.\n   */\n  static create(options?: {\n    ids?: TestDatabaseId[];\n    disableDocker?: boolean;\n  }): TestDatabases {\n    const ids = options?.ids;\n    const disableDocker = options?.disableDocker ?? isDockerDisabledForTests();\n\n    let testDatabaseIds: TestDatabaseId[];\n    if (ids) {\n      testDatabaseIds = ids;\n    } else if (TestDatabases.defaultIds) {\n      testDatabaseIds = TestDatabases.defaultIds;\n    } else {\n      testDatabaseIds = Object.keys(allDatabases) as TestDatabaseId[];\n    }\n\n    const supportedIds = testDatabaseIds.filter(id => {\n      const properties = allDatabases[id];\n      if (!properties) {\n        return false;\n      }\n      // If the caller has set up the env with an explicit connection string,\n      // we'll assume that this database will work\n      if (\n        properties.connectionStringEnvironmentVariableName &&\n        process.env[properties.connectionStringEnvironmentVariableName]\n      ) {\n        return true;\n      }\n      // If the database doesn't require docker at all, there's nothing to worry\n      // about\n      if (!properties.dockerImageName) {\n        return true;\n      }\n      // If the database requires docker, but docker is disabled, we will fail.\n      if (disableDocker) {\n        return false;\n      }\n      return true;\n    });\n\n    const databases = new TestDatabases(supportedIds);\n\n    if (supportedIds.length > 0) {\n      afterAll(async () => {\n        await databases.shutdown();\n      });\n    }\n\n    return databases;\n  }\n\n  static setDefaults(options: { ids?: TestDatabaseId[] }) {\n    TestDatabases.defaultIds = options.ids;\n  }\n\n  private constructor(supportedIds: TestDatabaseId[]) {\n    this.instanceById = new Map();\n    this.supportedIds = supportedIds;\n  }\n\n  supports(id: TestDatabaseId): boolean {\n    return this.supportedIds.includes(id);\n  }\n\n  eachSupportedId(): [TestDatabaseId][] {\n    return this.supportedIds.map(id => [id]);\n  }\n\n  /**\n   * Returns a fresh, unique, empty logical database on an instance of the\n   * given database ID platform.\n   *\n   * @param id - The ID of the database platform to use, e.g. 'POSTGRES_13'\n   * @returns A `Knex` connection object\n   */\n  async init(id: TestDatabaseId): Promise<Knex> {\n    const properties = allDatabases[id];\n    if (!properties) {\n      const candidates = Object.keys(allDatabases).join(', ');\n      throw new Error(\n        `Unknown test database ${id}, possible values are ${candidates}`,\n      );\n    }\n    if (!this.supportedIds.includes(id)) {\n      const candidates = this.supportedIds.join(', ');\n      throw new Error(\n        `Unsupported test database ${id} for this environment, possible values are ${candidates}`,\n      );\n    }\n\n    let instance: Instance | undefined = this.instanceById.get(id);\n\n    // Ensure that a testcontainers instance is up for this ID\n    if (!instance) {\n      instance = await this.initAny(properties);\n      this.instanceById.set(id, instance);\n    }\n\n    // Ensure that a unique logical database is created in the instance\n    const databaseName = `db${randomBytes(16).toString('hex')}`;\n    const connection = await instance.databaseManager\n      .forPlugin(databaseName)\n      .getClient();\n\n    instance.connections.push(connection);\n    instance.databaseNames.push(databaseName);\n\n    return connection;\n  }\n\n  private async initAny(properties: TestDatabaseProperties): Promise<Instance> {\n    // Use the connection string if provided\n    if (properties.driver === 'pg' || properties.driver === 'mysql2') {\n      const envVarName = properties.connectionStringEnvironmentVariableName;\n      if (envVarName) {\n        const connectionString = process.env[envVarName];\n        if (connectionString) {\n          const config = new ConfigReader({\n            backend: {\n              database: {\n                knexConfig: properties.driver.includes('sqlite')\n                  ? {}\n                  : LARGER_POOL_CONFIG,\n                client: properties.driver,\n                connection: connectionString,\n              },\n            },\n          });\n          const databaseManager = DatabaseManager.fromConfig(config);\n          const databaseNames: Array<string> = [];\n          return {\n            dropDatabases: async () => {\n              await dropDatabase(\n                config.getConfig('backend.database'),\n                ...databaseNames.map(\n                  databaseName => `backstage_plugin_${databaseName}`,\n                ),\n              );\n            },\n            databaseManager,\n            databaseNames,\n            connections: [],\n          };\n        }\n      }\n    }\n\n    // Otherwise start a container for the purpose\n    switch (properties.driver) {\n      case 'pg':\n        return this.initPostgres(properties);\n      case 'mysql2':\n        return this.initMysql(properties);\n      case 'better-sqlite3':\n      case 'sqlite3':\n        return this.initSqlite(properties);\n      default:\n        throw new Error(`Unknown database driver ${properties.driver}`);\n    }\n  }\n\n  private async initPostgres(\n    properties: TestDatabaseProperties,\n  ): Promise<Instance> {\n    const { host, port, user, password, stop } = await startPostgresContainer(\n      properties.dockerImageName!,\n    );\n\n    const databaseManager = DatabaseManager.fromConfig(\n      new ConfigReader({\n        backend: {\n          database: {\n            knexConfig: LARGER_POOL_CONFIG,\n            client: 'pg',\n            connection: { host, port, user, password },\n          },\n        },\n      }),\n    );\n    return {\n      stopContainer: stop,\n      databaseManager,\n      databaseNames: [],\n      connections: [],\n    };\n  }\n\n  private async initMysql(\n    properties: TestDatabaseProperties,\n  ): Promise<Instance> {\n    const { host, port, user, password, stop } = await startMysqlContainer(\n      properties.dockerImageName!,\n    );\n\n    const databaseManager = DatabaseManager.fromConfig(\n      new ConfigReader({\n        backend: {\n          database: {\n            knexConfig: LARGER_POOL_CONFIG,\n            client: 'mysql2',\n            connection: { host, port, user, password },\n          },\n        },\n      }),\n    );\n\n    return {\n      stopContainer: stop,\n      databaseManager,\n      databaseNames: [],\n      connections: [],\n    };\n  }\n\n  private async initSqlite(\n    properties: TestDatabaseProperties,\n  ): Promise<Instance> {\n    const databaseManager = DatabaseManager.fromConfig(\n      new ConfigReader({\n        backend: {\n          database: {\n            client: properties.driver,\n            connection: ':memory:',\n          },\n        },\n      }),\n    );\n    return {\n      databaseManager,\n      databaseNames: [],\n      connections: [],\n    };\n  }\n\n  private async shutdown() {\n    const instances = [...this.instanceById.values()];\n    this.instanceById.clear();\n\n    for (const {\n      stopContainer,\n      dropDatabases,\n      connections,\n      databaseManager,\n    } of instances) {\n      for (const connection of connections) {\n        try {\n          await connection.destroy();\n        } catch (error) {\n          console.warn(`TestDatabases: Failed to destroy connection`, {\n            connection,\n            error,\n          });\n        }\n      }\n\n      // If the database is not running in docker then drop the databases\n      try {\n        await dropDatabases?.();\n      } catch (error) {\n        console.warn(`TestDatabases: Failed to drop databases`, {\n          error,\n        });\n      }\n\n      try {\n        await stopContainer?.();\n      } catch (error) {\n        console.warn(`TestDatabases: Failed to stop container`, {\n          databaseManager,\n          error,\n        });\n      }\n    }\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Sets up handlers for request mocking\n * @public\n * @param worker - service worker\n */\nexport function setupRequestMockHandlers(worker: {\n  listen: (t: any) => void;\n  close: () => void;\n  resetHandlers: () => void;\n}) {\n  beforeAll(() => worker.listen({ onUnhandledRequest: 'error' }));\n  afterAll(() => worker.close());\n  afterEach(() => worker.resetHandlers());\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport os from 'os';\nimport { isChildPath } from '@backstage/backend-plugin-api';\nimport fs from 'fs-extra';\nimport textextensions from 'textextensions';\nimport {\n  dirname,\n  extname,\n  join as joinPath,\n  resolve as resolvePath,\n  relative as relativePath,\n  win32,\n  posix,\n} from 'path';\n\nconst tmpdirMarker = Symbol('os-tmpdir-mock');\n\n/**\n * A context that allows for more advanced file system operations when writing mock directory content.\n *\n * @public\n */\nexport interface MockDirectoryContentCallbackContext {\n  /** Absolute path to the location of this piece of content on the filesystem */\n  path: string;\n\n  /** Creates a symbolic link at the current location */\n  symlink(target: string): void;\n}\n\n/**\n * A callback that allows for more advanced file system operations when writing mock directory content.\n *\n * @public\n */\nexport type MockDirectoryContentCallback = (\n  ctx: MockDirectoryContentCallbackContext,\n) => void;\n\n/**\n * The content of a mock directory represented by a nested object structure.\n *\n * @remarks\n *\n * When used as input, the keys may contain forward slashes to indicate nested directories.\n * Then returned as output, each directory will always be represented as a separate object.\n *\n * @example\n * ```ts\n * {\n *   'test.txt': 'content',\n *   'sub-dir': {\n *     'file.txt': 'content',\n *     'nested-dir/file.txt': 'content',\n *   },\n *   'empty-dir': {},\n *   'binary-file': Buffer.from([0, 1, 2]),\n * }\n * ```\n *\n * @public\n */\nexport type MockDirectoryContent = {\n  [name in string]:\n    | MockDirectoryContent\n    | string\n    | Buffer\n    | MockDirectoryContentCallback;\n};\n\n/**\n * Options for {@link MockDirectory.content}.\n *\n * @public\n */\nexport interface MockDirectoryContentOptions {\n  /**\n   * The path to read content from. Defaults to the root of the mock directory.\n   *\n   * An absolute path can also be provided, as long as it is a child path of the mock directory.\n   */\n  path?: string;\n\n  /**\n   * Whether or not to return files as text rather than buffers.\n   *\n   * Defaults to checking the file extension against a list of known text extensions.\n   */\n  shouldReadAsText?: boolean | ((path: string, buffer: Buffer) => boolean);\n}\n\n/**\n * A utility for creating a mock directory that is automatically cleaned up.\n *\n * @public\n */\nexport interface MockDirectory {\n  /**\n   * The path to the root of the mock directory\n   */\n  readonly path: string;\n\n  /**\n   * Resolves a path relative to the root of the mock directory.\n   */\n  resolve(...paths: string[]): string;\n\n  /**\n   * Sets the content of the mock directory. This will remove any existing content.\n   *\n   * @example\n   * ```ts\n   * mockDir.setContent({\n   *   'test.txt': 'content',\n   *   'sub-dir': {\n   *     'file.txt': 'content',\n   *     'nested-dir/file.txt': 'content',\n   *   },\n   *   'empty-dir': {},\n   *   'binary-file': Buffer.from([0, 1, 2]),\n   * });\n   * ```\n   */\n  setContent(root: MockDirectoryContent): void;\n\n  /**\n   * Adds content of the mock directory. This will overwrite existing files.\n   *\n   * @example\n   * ```ts\n   * mockDir.addContent({\n   *   'test.txt': 'content',\n   *   'sub-dir': {\n   *     'file.txt': 'content',\n   *     'nested-dir/file.txt': 'content',\n   *   },\n   *   'empty-dir': {},\n   *   'binary-file': Buffer.from([0, 1, 2]),\n   * });\n   * ```\n   */\n  addContent(root: MockDirectoryContent): void;\n\n  /**\n   * Reads the content of the mock directory.\n   *\n   * @remarks\n   *\n   * Text files will be returned as strings, while binary files will be returned as buffers.\n   * By default the file extension is used to determine whether a file should be read as text.\n   *\n   * @example\n   * ```ts\n   * expect(mockDir.content()).toEqual({\n   *   'test.txt': 'content',\n   *   'sub-dir': {\n   *     'file.txt': 'content',\n   *     'nested-dir': {\n   *       'file.txt': 'content',\n   *     },\n   *   },\n   *   'empty-dir': {},\n   *   'binary-file': Buffer.from([0, 1, 2]),\n   * });\n   * ```\n   */\n  content(\n    options?: MockDirectoryContentOptions,\n  ): MockDirectoryContent | undefined;\n\n  /**\n   * Clears the content of the mock directory, ensuring that the directory itself exists.\n   */\n  clear(): void;\n\n  /**\n   * Removes the mock directory and all its contents.\n   */\n  remove(): void;\n}\n\n/** @internal */\ntype MockEntry =\n  | {\n      type: 'file';\n      path: string;\n      content: Buffer;\n    }\n  | {\n      type: 'dir';\n      path: string;\n    }\n  | {\n      type: 'callback';\n      path: string;\n      callback: MockDirectoryContentCallback;\n    };\n\n/** @internal */\nclass MockDirectoryImpl {\n  readonly #root: string;\n\n  constructor(root: string) {\n    this.#root = root;\n  }\n\n  get path(): string {\n    return this.#root;\n  }\n\n  resolve(...paths: string[]): string {\n    return resolvePath(this.#root, ...paths);\n  }\n\n  setContent(root: MockDirectoryContent): void {\n    this.remove();\n\n    return this.addContent(root);\n  }\n\n  addContent(root: MockDirectoryContent): void {\n    const entries = this.#transformInput(root);\n\n    for (const entry of entries) {\n      const fullPath = resolvePath(this.#root, entry.path);\n      if (!isChildPath(this.#root, fullPath)) {\n        throw new Error(\n          `Provided path must resolve to a child path of the mock directory, got '${fullPath}'`,\n        );\n      }\n\n      if (entry.type === 'dir') {\n        fs.ensureDirSync(fullPath);\n      } else if (entry.type === 'file') {\n        fs.ensureDirSync(dirname(fullPath));\n        fs.writeFileSync(fullPath, entry.content);\n      } else if (entry.type === 'callback') {\n        fs.ensureDirSync(dirname(fullPath));\n        entry.callback({\n          path: fullPath,\n          symlink(target: string) {\n            fs.symlinkSync(target, fullPath);\n          },\n        });\n      }\n    }\n  }\n\n  content(\n    options?: MockDirectoryContentOptions,\n  ): MockDirectoryContent | undefined {\n    const shouldReadAsText =\n      (typeof options?.shouldReadAsText === 'boolean'\n        ? () => options?.shouldReadAsText\n        : options?.shouldReadAsText) ??\n      ((path: string) => textextensions.includes(extname(path).slice(1)));\n\n    const root = resolvePath(this.#root, options?.path ?? '');\n    if (!isChildPath(this.#root, root)) {\n      throw new Error(\n        `Provided path must resolve to a child path of the mock directory, got '${root}'`,\n      );\n    }\n\n    function read(path: string): MockDirectoryContent | undefined {\n      if (!fs.pathExistsSync(path)) {\n        return undefined;\n      }\n\n      const entries = fs.readdirSync(path, { withFileTypes: true });\n      return Object.fromEntries(\n        entries.map(entry => {\n          const fullPath = resolvePath(path, entry.name);\n\n          if (entry.isDirectory()) {\n            return [entry.name, read(fullPath)];\n          }\n          const content = fs.readFileSync(fullPath);\n          const relativePosixPath = relativePath(root, fullPath)\n            .split(win32.sep)\n            .join(posix.sep);\n\n          if (shouldReadAsText(relativePosixPath, content)) {\n            return [entry.name, content.toString('utf8')];\n          }\n          return [entry.name, content];\n        }),\n      );\n    }\n\n    return read(root);\n  }\n\n  clear = (): void => {\n    this.setContent({});\n  };\n\n  remove = (): void => {\n    fs.rmSync(this.#root, { recursive: true, force: true, maxRetries: 10 });\n  };\n\n  #transformInput(input: MockDirectoryContent[string]): MockEntry[] {\n    const entries: MockEntry[] = [];\n\n    function traverse(node: MockDirectoryContent[string], path: string) {\n      if (typeof node === 'string') {\n        entries.push({\n          type: 'file',\n          path,\n          content: Buffer.from(node, 'utf8'),\n        });\n      } else if (node instanceof Buffer) {\n        entries.push({ type: 'file', path, content: node });\n      } else if (typeof node === 'function') {\n        entries.push({ type: 'callback', path, callback: node });\n      } else {\n        entries.push({ type: 'dir', path });\n        for (const [name, child] of Object.entries(node)) {\n          traverse(child, path ? `${path}/${name}` : name);\n        }\n      }\n    }\n\n    traverse(input, '');\n\n    return entries;\n  }\n}\n\n/**\n * Options for {@link createMockDirectory}.\n *\n * @public\n */\nexport interface MockDirectoryOptions {\n  /**\n   * In addition to creating a temporary directory, also mock `os.tmpdir()` to return the\n   * mock directory path until the end of the test suite.\n   *\n   * @returns\n   */\n  mockOsTmpDir?: boolean;\n\n  /**\n   * Initializes the directory with the given content, see {@link MockDirectory.setContent}.\n   */\n  content?: MockDirectoryContent;\n}\n\n/**\n * Creates a new temporary mock directory that will be removed after the tests have completed.\n *\n * @public\n * @remarks\n *\n * This method is intended to be called outside of any test, either at top-level or\n * within a `describe` block. It will call `afterAll` to make sure that the mock directory\n * is removed after the tests have run.\n *\n * @example\n * ```ts\n * describe('MySubject', () => {\n *   const mockDir = createMockDirectory();\n *\n *   beforeEach(mockDir.clear);\n *\n *   it('should work', () => {\n *     // ... use mockDir\n *   })\n * })\n * ```\n */\nexport function createMockDirectory(\n  options?: MockDirectoryOptions,\n): MockDirectory {\n  const tmpDir = process.env.RUNNER_TEMP || os.tmpdir(); // GitHub Actions\n  const root = fs.mkdtempSync(joinPath(tmpDir, 'backstage-tmp-test-dir-'));\n\n  const mocker = new MockDirectoryImpl(root);\n\n  const origTmpdir = options?.mockOsTmpDir ? os.tmpdir : undefined;\n  if (origTmpdir) {\n    if (Object.hasOwn(origTmpdir, tmpdirMarker)) {\n      throw new Error(\n        'Cannot mock os.tmpdir() when it has already been mocked',\n      );\n    }\n    const mock = Object.assign(() => mocker.path, { [tmpdirMarker]: true });\n    os.tmpdir = mock;\n  }\n\n  // In CI we expect there to be no need to clean up temporary directories\n  const needsCleanup = !process.env.CI;\n  if (needsCleanup) {\n    process.on('beforeExit', mocker.remove);\n  }\n\n  try {\n    afterAll(() => {\n      if (origTmpdir) {\n        os.tmpdir = origTmpdir;\n      }\n      if (needsCleanup) {\n        mocker.remove();\n      }\n    });\n  } catch {\n    /* ignore */\n  }\n\n  if (options?.content) {\n    mocker.setContent(options.content);\n  }\n\n  return mocker;\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { IdentityService } from '@backstage/backend-plugin-api';\nimport {\n  IdentityApiGetIdentityRequest,\n  BackstageIdentityResponse,\n} from '@backstage/plugin-auth-node';\n\nexport class MockIdentityService implements IdentityService {\n  getIdentity(\n    _options: IdentityApiGetIdentityRequest,\n  ): Promise<BackstageIdentityResponse | undefined> {\n    return Promise.resolve({\n      token: 'mock-token',\n      identity: {\n        type: 'user',\n        userEntityRef: 'user:default/mock-user',\n        ownershipEntityRefs: [],\n      },\n    });\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  LoggerService,\n  RootLoggerService,\n} from '@backstage/backend-plugin-api';\nimport { JsonObject } from '@backstage/types';\nimport type { mockServices } from './mockServices';\n\nconst levels = {\n  none: 0,\n  error: 1,\n  warn: 2,\n  info: 3,\n  debug: 4,\n};\n\nexport class MockRootLoggerService implements RootLoggerService {\n  #level: number;\n  #meta: JsonObject;\n\n  static create(\n    options?: mockServices.rootLogger.Options,\n  ): MockRootLoggerService {\n    const level = options?.level ?? 'none';\n    if (!(level in levels)) {\n      throw new Error(`Invalid log level '${level}'`);\n    }\n    return new MockRootLoggerService(levels[level], {});\n  }\n\n  error(message: string, meta?: JsonObject | Error | undefined): void {\n    this.#log('error', message, meta);\n  }\n\n  warn(message: string, meta?: JsonObject | Error | undefined): void {\n    this.#log('warn', message, meta);\n  }\n\n  info(message: string, meta?: JsonObject | Error | undefined): void {\n    this.#log('info', message, meta);\n  }\n\n  debug(message: string, meta?: JsonObject | Error | undefined): void {\n    this.#log('debug', message, meta);\n  }\n\n  child(meta: JsonObject): LoggerService {\n    return new MockRootLoggerService(this.#level, { ...this.#meta, ...meta });\n  }\n\n  private constructor(level: number, meta: JsonObject) {\n    this.#level = level;\n    this.#meta = meta;\n  }\n\n  #log(\n    level: 'error' | 'warn' | 'info' | 'debug',\n    message: string,\n    meta?: JsonObject | Error | undefined,\n  ) {\n    const levelValue = levels[level] ?? 0;\n    if (levelValue <= this.#level) {\n      const labels = Object.entries(this.#meta)\n        .map(([key, value]) => `${key}=${value}`)\n        .join(',');\n      console[level](`${labels} ${message}`, meta);\n    }\n  }\n}\n","/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageCredentials,\n  BackstageNonePrincipal,\n  BackstageServicePrincipal,\n  BackstageUserPrincipal,\n} from '@backstage/backend-plugin-api';\n\nexport const DEFAULT_MOCK_USER_ENTITY_REF = 'user:default/mock';\nexport const DEFAULT_MOCK_SERVICE_SUBJECT = 'external:test-service';\n\nexport const MOCK_AUTH_COOKIE = 'backstage-auth';\n\nexport const MOCK_NONE_TOKEN = 'mock-none-token';\n\nexport const MOCK_USER_TOKEN = 'mock-user-token';\nexport const MOCK_USER_TOKEN_PREFIX = 'mock-user-token:';\nexport const MOCK_INVALID_USER_TOKEN = 'mock-invalid-user-token';\n\nexport const MOCK_USER_LIMITED_TOKEN_PREFIX = 'mock-limited-user-token:';\nexport const MOCK_INVALID_USER_LIMITED_TOKEN =\n  'mock-invalid-limited-user-token';\n\nexport const MOCK_SERVICE_TOKEN = 'mock-service-token';\nexport const MOCK_SERVICE_TOKEN_PREFIX = 'mock-service-token:';\nexport const MOCK_INVALID_SERVICE_TOKEN = 'mock-invalid-service-token';\n\nfunction validateUserEntityRef(ref: string) {\n  if (!ref.match(/^.+:.+\\/.+$/)) {\n    throw new TypeError(\n      `Invalid user entity reference '${ref}', expected <kind>:<namespace>/<name>`,\n    );\n  }\n}\n\n/**\n * The payload that can be encoded into a mock user token.\n * @internal\n */\nexport type UserTokenPayload = {\n  sub?: string;\n};\n\n/**\n * The payload that can be encoded into a mock service token.\n * @internal\n */\nexport type ServiceTokenPayload = {\n  sub?: string; // service subject\n  obo?: string; // user entity reference\n  target?: string; // target plugin id\n};\n\n/**\n * @public\n */\nexport namespace mockCredentials {\n  /**\n   * Creates a mocked credentials object for a unauthenticated principal.\n   */\n  export function none(): BackstageCredentials<BackstageNonePrincipal> {\n    return {\n      $$type: '@backstage/BackstageCredentials',\n      principal: { type: 'none' },\n    };\n  }\n\n  /**\n   * Utilities related to none credentials.\n   */\n  export namespace none {\n    /**\n     * Returns an authorization header that translates to unauthenticated\n     * credentials.\n     *\n     * This is useful when one wants to explicitly test unauthenticated requests\n     * while still using the default behavior of the mock HttpAuthService where\n     * it defaults to user credentials.\n     */\n    export function header(): string {\n      // NOTE: there is no .token() version of this because only the\n      //       HttpAuthService should know about and consume this token\n      return `Bearer ${MOCK_NONE_TOKEN}`;\n    }\n  }\n\n  /**\n   * Creates a mocked credentials object for a user principal.\n   *\n   * The default user entity reference is 'user:default/mock'.\n   */\n  export function user(\n    userEntityRef: string = DEFAULT_MOCK_USER_ENTITY_REF,\n  ): BackstageCredentials<BackstageUserPrincipal> {\n    validateUserEntityRef(userEntityRef);\n    return {\n      $$type: '@backstage/BackstageCredentials',\n      principal: { type: 'user', userEntityRef },\n    };\n  }\n\n  /**\n   * Utilities related to user credentials.\n   */\n  export namespace user {\n    /**\n     * Creates a mocked user token. If a payload is provided it will be encoded\n     * into the token and forwarded to the credentials object when authenticated\n     * by the mock auth service.\n     */\n    export function token(userEntityRef?: string): string {\n      if (userEntityRef) {\n        validateUserEntityRef(userEntityRef);\n        return `${MOCK_USER_TOKEN_PREFIX}${JSON.stringify({\n          sub: userEntityRef,\n        } satisfies UserTokenPayload)}`;\n      }\n      return MOCK_USER_TOKEN;\n    }\n\n    /**\n     * Returns an authorization header with a mocked user token. If a payload is\n     * provided it will be encoded into the token and forwarded to the\n     * credentials object when authenticated by the mock auth service.\n     */\n    export function header(userEntityRef?: string): string {\n      return `Bearer ${token(userEntityRef)}`;\n    }\n\n    export function invalidToken(): string {\n      return MOCK_INVALID_USER_TOKEN;\n    }\n\n    export function invalidHeader(): string {\n      return `Bearer ${invalidToken()}`;\n    }\n  }\n\n  /**\n   * Creates a mocked credentials object for a user principal with limited\n   * access.\n   *\n   * The default user entity reference is 'user:default/mock'.\n   */\n  export function limitedUser(\n    userEntityRef: string = DEFAULT_MOCK_USER_ENTITY_REF,\n  ): BackstageCredentials<BackstageUserPrincipal> {\n    return user(userEntityRef);\n  }\n\n  /**\n   * Utilities related to limited user credentials.\n   */\n  export namespace limitedUser {\n    /**\n     * Creates a mocked limited user token. If a payload is provided it will be\n     * encoded into the token and forwarded to the credentials object when\n     * authenticated by the mock auth service.\n     */\n    export function token(\n      userEntityRef: string = DEFAULT_MOCK_USER_ENTITY_REF,\n    ): string {\n      validateUserEntityRef(userEntityRef);\n      return `${MOCK_USER_LIMITED_TOKEN_PREFIX}${JSON.stringify({\n        sub: userEntityRef,\n      } satisfies UserTokenPayload)}`;\n    }\n\n    /**\n     * Returns an authorization header with a mocked limited user token. If a\n     * payload is provided it will be encoded into the token and forwarded to\n     * the credentials object when authenticated by the mock auth service.\n     */\n    export function cookie(userEntityRef?: string): string {\n      return `${MOCK_AUTH_COOKIE}=${token(userEntityRef)}`;\n    }\n\n    export function invalidToken(): string {\n      return MOCK_INVALID_USER_LIMITED_TOKEN;\n    }\n\n    export function invalidCookie(): string {\n      return `${MOCK_AUTH_COOKIE}=${invalidToken()}`;\n    }\n  }\n\n  /**\n   * Creates a mocked credentials object for a service principal.\n   *\n   * The default subject is 'external:test-service'.\n   */\n  export function service(\n    subject: string = DEFAULT_MOCK_SERVICE_SUBJECT,\n  ): BackstageCredentials<BackstageServicePrincipal> {\n    return {\n      $$type: '@backstage/BackstageCredentials',\n      principal: { type: 'service', subject },\n    };\n  }\n\n  /**\n   * Utilities related to service credentials.\n   */\n  export namespace service {\n    /**\n     * Options for the creation of mock service tokens.\n     */\n    export type TokenOptions = {\n      onBehalfOf: BackstageCredentials;\n      targetPluginId: string;\n    };\n\n    /**\n     * Creates a mocked service token. The provided options will be encoded into\n     * the token and forwarded to the credentials object when authenticated by\n     * the mock auth service.\n     */\n    export function token(options?: TokenOptions): string {\n      if (options) {\n        const { targetPluginId, onBehalfOf } = options; // for fixed ordering\n\n        const oboPrincipal = onBehalfOf?.principal as\n          | BackstageServicePrincipal\n          | BackstageUserPrincipal\n          | BackstageNonePrincipal;\n        const obo =\n          oboPrincipal.type === 'user' ? oboPrincipal.userEntityRef : undefined;\n        const subject =\n          oboPrincipal.type === 'service' ? oboPrincipal.subject : undefined;\n\n        return `${MOCK_SERVICE_TOKEN_PREFIX}${JSON.stringify({\n          sub: subject,\n          obo,\n          target: targetPluginId,\n        } satisfies ServiceTokenPayload)}`;\n      }\n      return MOCK_SERVICE_TOKEN;\n    }\n\n    /**\n     * Returns an authorization header with a mocked service token. The provided\n     * options will be encoded into the token and forwarded to the credentials\n     * object when authenticated by the mock auth service.\n     */\n    export function header(options?: TokenOptions): string {\n      return `Bearer ${token(options)}`;\n    }\n\n    export function invalidToken(): string {\n      return MOCK_INVALID_SERVICE_TOKEN;\n    }\n\n    export function invalidHeader(): string {\n      return `Bearer ${invalidToken()}`;\n    }\n  }\n}\n","/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageCredentials,\n  BackstageServicePrincipal,\n  BackstagePrincipalTypes,\n  BackstageUserPrincipal,\n  BackstageNonePrincipal,\n  AuthService,\n} from '@backstage/backend-plugin-api';\nimport { AuthenticationError } from '@backstage/errors';\nimport {\n  mockCredentials,\n  MOCK_USER_TOKEN,\n  MOCK_USER_TOKEN_PREFIX,\n  MOCK_INVALID_USER_TOKEN,\n  MOCK_USER_LIMITED_TOKEN_PREFIX,\n  MOCK_INVALID_USER_LIMITED_TOKEN,\n  MOCK_SERVICE_TOKEN,\n  MOCK_SERVICE_TOKEN_PREFIX,\n  MOCK_INVALID_SERVICE_TOKEN,\n  UserTokenPayload,\n  ServiceTokenPayload,\n} from './mockCredentials';\nimport { JsonObject } from '@backstage/types';\n\n/** @internal */\nexport class MockAuthService implements AuthService {\n  readonly pluginId: string;\n  readonly disableDefaultAuthPolicy: boolean;\n\n  constructor(options: {\n    pluginId: string;\n    disableDefaultAuthPolicy: boolean;\n  }) {\n    this.pluginId = options.pluginId;\n    this.disableDefaultAuthPolicy = options.disableDefaultAuthPolicy;\n  }\n\n  async authenticate(\n    token: string,\n    options?: { allowLimitedAccess?: boolean },\n  ): Promise<BackstageCredentials> {\n    switch (token) {\n      case MOCK_USER_TOKEN:\n        return mockCredentials.user();\n      case MOCK_SERVICE_TOKEN:\n        return mockCredentials.service();\n      case MOCK_INVALID_USER_TOKEN:\n        throw new AuthenticationError('User token is invalid');\n      case MOCK_INVALID_USER_LIMITED_TOKEN:\n        throw new AuthenticationError('Limited user token is invalid');\n      case MOCK_INVALID_SERVICE_TOKEN:\n        throw new AuthenticationError('Service token is invalid');\n      case '':\n        throw new AuthenticationError('Token is empty');\n      default:\n        break;\n    }\n\n    if (token.startsWith(MOCK_USER_TOKEN_PREFIX)) {\n      const { sub: userEntityRef }: UserTokenPayload = JSON.parse(\n        token.slice(MOCK_USER_TOKEN_PREFIX.length),\n      );\n\n      return mockCredentials.user(userEntityRef);\n    }\n\n    if (token.startsWith(MOCK_USER_LIMITED_TOKEN_PREFIX)) {\n      if (!options?.allowLimitedAccess) {\n        throw new AuthenticationError('Limited user token is not allowed');\n      }\n\n      const { sub: userEntityRef }: UserTokenPayload = JSON.parse(\n        token.slice(MOCK_USER_LIMITED_TOKEN_PREFIX.length),\n      );\n\n      return mockCredentials.user(userEntityRef);\n    }\n\n    if (token.startsWith(MOCK_SERVICE_TOKEN_PREFIX)) {\n      const { sub, target, obo }: ServiceTokenPayload = JSON.parse(\n        token.slice(MOCK_SERVICE_TOKEN_PREFIX.length),\n      );\n\n      if (target && target !== this.pluginId) {\n        throw new AuthenticationError(\n          `Invalid mock token target plugin ID, got '${target}' but expected '${this.pluginId}'`,\n        );\n      }\n      if (obo) {\n        return mockCredentials.user(obo);\n      }\n\n      return mockCredentials.service(sub);\n    }\n\n    throw new AuthenticationError(`Unknown mock token '${token}'`);\n  }\n\n  async getNoneCredentials() {\n    return mockCredentials.none();\n  }\n\n  async getOwnServiceCredentials(): Promise<\n    BackstageCredentials<BackstageServicePrincipal>\n  > {\n    return mockCredentials.service(`plugin:${this.pluginId}`);\n  }\n\n  isPrincipal<TType extends keyof BackstagePrincipalTypes>(\n    credentials: BackstageCredentials,\n    type: TType,\n  ): credentials is BackstageCredentials<BackstagePrincipalTypes[TType]> {\n    const principal = credentials.principal as\n      | BackstageUserPrincipal\n      | BackstageServicePrincipal\n      | BackstageNonePrincipal;\n\n    if (type === 'unknown') {\n      return true;\n    }\n\n    if (principal.type !== type) {\n      return false;\n    }\n\n    return true;\n  }\n\n  async getPluginRequestToken(options: {\n    onBehalfOf: BackstageCredentials;\n    targetPluginId: string;\n  }): Promise<{ token: string }> {\n    const principal = options.onBehalfOf.principal as\n      | BackstageUserPrincipal\n      | BackstageServicePrincipal\n      | BackstageNonePrincipal;\n\n    if (principal.type === 'none' && this.disableDefaultAuthPolicy) {\n      return { token: '' };\n    }\n\n    if (principal.type !== 'user' && principal.type !== 'service') {\n      throw new AuthenticationError(\n        `Refused to issue service token for credential type '${principal.type}'`,\n      );\n    }\n\n    return {\n      token: mockCredentials.service.token({\n        onBehalfOf: options.onBehalfOf,\n        targetPluginId: options.targetPluginId,\n      }),\n    };\n  }\n\n  async getLimitedUserToken(\n    credentials: BackstageCredentials<BackstageUserPrincipal>,\n  ): Promise<{ token: string; expiresAt: Date }> {\n    if (credentials.principal.type !== 'user') {\n      throw new AuthenticationError(\n        `Refused to issue limited user token for credential type '${credentials.principal.type}'`,\n      );\n    }\n\n    return {\n      token: mockCredentials.limitedUser.token(\n        credentials.principal.userEntityRef,\n      ),\n      expiresAt: new Date(Date.now() + 3600_000),\n    };\n  }\n\n  listPublicServiceKeys(): Promise<{ keys: JsonObject[] }> {\n    throw new Error('Not implemented');\n  }\n}\n","/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthService,\n  BackstageCredentials,\n  BackstagePrincipalTypes,\n  BackstageUserPrincipal,\n  HttpAuthService,\n} from '@backstage/backend-plugin-api';\nimport { Request, Response } from 'express';\nimport { parse as parseCookie } from 'cookie';\nimport { MockAuthService } from './MockAuthService';\nimport { AuthenticationError, NotAllowedError } from '@backstage/errors';\nimport {\n  MOCK_NONE_TOKEN,\n  MOCK_AUTH_COOKIE,\n  mockCredentials,\n} from './mockCredentials';\n\n// TODO: support mock cookie auth?\nexport class MockHttpAuthService implements HttpAuthService {\n  #auth: AuthService;\n  #defaultCredentials: BackstageCredentials;\n\n  constructor(pluginId: string, defaultCredentials: BackstageCredentials) {\n    this.#auth = new MockAuthService({\n      pluginId,\n      disableDefaultAuthPolicy: false,\n    });\n    this.#defaultCredentials = defaultCredentials;\n  }\n\n  async #getCredentials(req: Request, allowLimitedAccess: boolean) {\n    const header = req.headers.authorization;\n    const token =\n      typeof header === 'string'\n        ? header.match(/^Bearer[ ]+(\\S+)$/i)?.[1]\n        : undefined;\n\n    if (token) {\n      if (token === MOCK_NONE_TOKEN) {\n        return this.#auth.getNoneCredentials();\n      }\n\n      return await this.#auth.authenticate(token, {\n        allowLimitedAccess,\n      });\n    }\n\n    if (allowLimitedAccess) {\n      const cookieHeader = req.headers.cookie;\n\n      if (cookieHeader) {\n        const cookies = parseCookie(cookieHeader);\n        const cookie = cookies[MOCK_AUTH_COOKIE];\n\n        if (cookie) {\n          return await this.#auth.authenticate(cookie, {\n            allowLimitedAccess: true,\n          });\n        }\n      }\n    }\n\n    return this.#defaultCredentials;\n  }\n\n  async credentials<TAllowed extends keyof BackstagePrincipalTypes = 'unknown'>(\n    req: Request,\n    options?: {\n      allow?: Array<TAllowed>;\n      allowLimitedAccess?: boolean;\n    },\n  ): Promise<BackstageCredentials<BackstagePrincipalTypes[TAllowed]>> {\n    const credentials = await this.#getCredentials(\n      req,\n      options?.allowLimitedAccess ?? false,\n    );\n\n    const allowedPrincipalTypes = options?.allow;\n    if (!allowedPrincipalTypes) {\n      return credentials as any;\n    }\n\n    if (this.#auth.isPrincipal(credentials, 'none')) {\n      if (allowedPrincipalTypes.includes('none' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new AuthenticationError('Missing credentials');\n    } else if (this.#auth.isPrincipal(credentials, 'user')) {\n      if (allowedPrincipalTypes.includes('user' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new NotAllowedError(\n        `This endpoint does not allow 'user' credentials`,\n      );\n    } else if (this.#auth.isPrincipal(credentials, 'service')) {\n      if (allowedPrincipalTypes.includes('service' as TAllowed)) {\n        return credentials as any;\n      }\n\n      throw new NotAllowedError(\n        `This endpoint does not allow 'service' credentials`,\n      );\n    }\n\n    throw new NotAllowedError(\n      'Unknown principal type, this should never happen',\n    );\n  }\n\n  async issueUserCookie(\n    res: Response,\n    options?: { credentials?: BackstageCredentials<BackstageUserPrincipal> },\n  ): Promise<{ expiresAt: Date }> {\n    const credentials =\n      options?.credentials ??\n      (await this.credentials(res.req, { allow: ['user'] }));\n\n    res.setHeader(\n      'Set-Cookie',\n      mockCredentials.limitedUser.cookie(credentials.principal.userEntityRef),\n    );\n\n    return { expiresAt: new Date(Date.now() + 3600_000) };\n  }\n}\n","/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BackstageCredentials,\n  BackstageNonePrincipal,\n  BackstageServicePrincipal,\n  BackstageUserInfo,\n  BackstageUserPrincipal,\n  UserInfoService,\n} from '@backstage/backend-plugin-api';\nimport { InputError } from '@backstage/errors';\n\n/** @internal */\nexport class MockUserInfoService implements UserInfoService {\n  private readonly customInfo: Partial<BackstageUserInfo>;\n\n  constructor(customInfo?: Partial<BackstageUserInfo>) {\n    this.customInfo = customInfo ?? {};\n  }\n\n  async getUserInfo(\n    credentials: BackstageCredentials,\n  ): Promise<BackstageUserInfo> {\n    const principal = credentials.principal as\n      | BackstageUserPrincipal\n      | BackstageServicePrincipal\n      | BackstageNonePrincipal;\n\n    if (principal.type !== 'user') {\n      throw new InputError(\n        `User info not available for principal type '${principal.type}'`,\n      );\n    }\n\n    return {\n      userEntityRef: principal.userEntityRef,\n      ownershipEntityRefs: [principal.userEntityRef],\n      ...this.customInfo,\n    };\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  RootConfigService,\n  coreServices,\n  createServiceFactory,\n  IdentityService,\n  LoggerService,\n  ServiceFactory,\n  ServiceRef,\n  TokenManagerService,\n  AuthService,\n  DiscoveryService,\n  HttpAuthService,\n  BackstageCredentials,\n  BackstageUserInfo,\n  UserInfoService,\n} from '@backstage/backend-plugin-api';\nimport {\n  cacheServiceFactory,\n  databaseServiceFactory,\n  httpRouterServiceFactory,\n  lifecycleServiceFactory,\n  loggerServiceFactory,\n  permissionsServiceFactory,\n  rootHttpRouterServiceFactory,\n  rootLifecycleServiceFactory,\n  schedulerServiceFactory,\n  urlReaderServiceFactory,\n  discoveryServiceFactory,\n  HostDiscovery,\n} from '@backstage/backend-app-api';\nimport { ConfigReader } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { MockIdentityService } from './MockIdentityService';\nimport { MockRootLoggerService } from './MockRootLoggerService';\nimport { MockAuthService } from './MockAuthService';\nimport { MockHttpAuthService } from './MockHttpAuthService';\nimport { mockCredentials } from './mockCredentials';\nimport { MockUserInfoService } from './MockUserInfoService';\nimport {\n  eventsServiceFactory,\n  eventsServiceRef,\n} from '@backstage/plugin-events-node';\n\n/** @internal */\nfunction simpleFactory<\n  TService,\n  TScope extends 'root' | 'plugin',\n  TOptions extends [options?: object] = [],\n>(\n  ref: ServiceRef<TService, TScope>,\n  factory: (...options: TOptions) => TService,\n): (...options: TOptions) => ServiceFactory<TService, TScope> {\n  return createServiceFactory((options: unknown) => ({\n    service: ref as ServiceRef<TService, any>,\n    deps: {},\n    async factory() {\n      return (factory as any)(options);\n    },\n  })) as (...options: TOptions) => ServiceFactory<TService, any>;\n}\n\n/** @public */\nexport type ServiceMock<TService> = {\n  factory: ServiceFactory<TService>;\n} & {\n  [Key in keyof TService]: TService[Key] extends (\n    ...args: infer Args\n  ) => infer Return\n    ? TService[Key] & jest.MockInstance<Return, Args>\n    : TService[Key];\n};\n\n/** @internal */\nfunction simpleMock<TService>(\n  ref: ServiceRef<TService, any>,\n  mockFactory: () => jest.Mocked<TService>,\n): (partialImpl?: Partial<TService>) => ServiceMock<TService> {\n  return partialImpl => {\n    const mock = mockFactory();\n    if (partialImpl) {\n      for (const [key, impl] of Object.entries(partialImpl)) {\n        if (typeof impl === 'function') {\n          (mock as any)[key].mockImplementation(impl);\n        } else {\n          (mock as any)[key] = impl;\n        }\n      }\n    }\n    return Object.assign(mock, {\n      factory: createServiceFactory({\n        service: ref,\n        deps: {},\n        factory: () => mock,\n      })(),\n    }) as ServiceMock<TService>;\n  };\n}\n\n/**\n * @public\n */\nexport namespace mockServices {\n  export function rootConfig(options?: rootConfig.Options): RootConfigService {\n    return new ConfigReader(options?.data, 'mock-config');\n  }\n  export namespace rootConfig {\n    export type Options = { data?: JsonObject };\n\n    export const factory = simpleFactory(coreServices.rootConfig, rootConfig);\n  }\n\n  export function rootLogger(options?: rootLogger.Options): LoggerService {\n    return MockRootLoggerService.create(options);\n  }\n  export namespace rootLogger {\n    export type Options = {\n      level?: 'none' | 'error' | 'warn' | 'info' | 'debug';\n    };\n\n    export const factory = simpleFactory(coreServices.rootLogger, rootLogger);\n    export const mock = simpleMock(coreServices.rootLogger, () => ({\n      child: jest.fn(),\n      debug: jest.fn(),\n      error: jest.fn(),\n      info: jest.fn(),\n      warn: jest.fn(),\n    }));\n  }\n\n  export function tokenManager(): TokenManagerService {\n    return {\n      async getToken(): Promise<{ token: string }> {\n        return { token: 'mock-token' };\n      },\n      async authenticate(token: string): Promise<void> {\n        if (token !== 'mock-token') {\n          throw new Error('Invalid token');\n        }\n      },\n    };\n  }\n  export namespace tokenManager {\n    export const factory = simpleFactory(\n      coreServices.tokenManager,\n      tokenManager,\n    );\n    export const mock = simpleMock(coreServices.tokenManager, () => ({\n      authenticate: jest.fn(),\n      getToken: jest.fn(),\n    }));\n  }\n\n  export function identity(): IdentityService {\n    return new MockIdentityService();\n  }\n  export namespace identity {\n    export const factory = simpleFactory(coreServices.identity, identity);\n    export const mock = simpleMock(coreServices.identity, () => ({\n      getIdentity: jest.fn(),\n    }));\n  }\n\n  export function auth(options?: {\n    pluginId?: string;\n    disableDefaultAuthPolicy?: boolean;\n  }): AuthService {\n    return new MockAuthService({\n      pluginId: options?.pluginId ?? 'test',\n      disableDefaultAuthPolicy: Boolean(options?.disableDefaultAuthPolicy),\n    });\n  }\n  export namespace auth {\n    export const factory = createServiceFactory({\n      service: coreServices.auth,\n      deps: {\n        plugin: coreServices.pluginMetadata,\n        config: coreServices.rootConfig,\n      },\n      factory({ plugin, config }) {\n        const disableDefaultAuthPolicy = Boolean(\n          config.getOptionalBoolean(\n            'backend.auth.dangerouslyDisableDefaultAuthPolicy',\n          ),\n        );\n        return new MockAuthService({\n          pluginId: plugin.getId(),\n          disableDefaultAuthPolicy,\n        });\n      },\n    });\n    export const mock = simpleMock(coreServices.auth, () => ({\n      authenticate: jest.fn(),\n      getNoneCredentials: jest.fn(),\n      getOwnServiceCredentials: jest.fn(),\n      isPrincipal: jest.fn() as any,\n      getPluginRequestToken: jest.fn(),\n      getLimitedUserToken: jest.fn(),\n      listPublicServiceKeys: jest.fn(),\n    }));\n  }\n\n  export function discovery(): DiscoveryService {\n    return HostDiscovery.fromConfig(\n      new ConfigReader({\n        backend: {\n          // Invalid port to make sure that requests are always mocked\n          baseUrl: 'http://localhost:0',\n          listen: { port: 0 },\n        },\n      }),\n    );\n  }\n  export namespace discovery {\n    export const factory = discoveryServiceFactory;\n    export const mock = simpleMock(coreServices.discovery, () => ({\n      getBaseUrl: jest.fn(),\n      getExternalBaseUrl: jest.fn(),\n    }));\n  }\n\n  /**\n   * Creates a mock implementation of the `HttpAuthService`.\n   *\n   * By default all requests without credentials are treated as requests from\n   * the default mock user principal. This behavior can be configured with the\n   * `defaultCredentials` option.\n   */\n  export function httpAuth(options?: {\n    pluginId?: string;\n    /**\n     * The default credentials to use if there are no credentials present in the\n     * incoming request.\n     *\n     * By default all requests without credentials are treated as authenticated\n     * as the default mock user as returned from `mockCredentials.user()`.\n     */\n    defaultCredentials?: BackstageCredentials;\n  }): HttpAuthService {\n    return new MockHttpAuthService(\n      options?.pluginId ?? 'test',\n      options?.defaultCredentials ?? mockCredentials.user(),\n    );\n  }\n  export namespace httpAuth {\n    /**\n     * Creates a mock service factory for the `HttpAuthService`.\n     *\n     * By default all requests without credentials are treated as requests from\n     * the default mock user principal. This behavior can be configured with the\n     * `defaultCredentials` option.\n     */\n    export const factory = createServiceFactory(\n      (options?: { defaultCredentials?: BackstageCredentials }) => ({\n        service: coreServices.httpAuth,\n        deps: { plugin: coreServices.pluginMetadata },\n        factory: ({ plugin }) =>\n          new MockHttpAuthService(\n            plugin.getId(),\n            options?.defaultCredentials ?? mockCredentials.user(),\n          ),\n      }),\n    );\n    export const mock = simpleMock(coreServices.httpAuth, () => ({\n      credentials: jest.fn(),\n      issueUserCookie: jest.fn(),\n    }));\n  }\n\n  /**\n   * Creates a mock implementation of the `UserInfoService`.\n   *\n   * By default it extracts the user's entity ref from a user principal and\n   * returns that as the only ownership entity ref, but this can be overridden\n   * by passing in a custom set of user info.\n   */\n  export function userInfo(\n    customInfo?: Partial<BackstageUserInfo>,\n  ): UserInfoService {\n    return new MockUserInfoService(customInfo);\n  }\n  export namespace userInfo {\n    /**\n     * Creates a mock service factory for the `UserInfoService`.\n     *\n     * By default it extracts the user's entity ref from a user principal and\n     * returns that as the only ownership entity ref.\n     */\n    export const factory = createServiceFactory({\n      service: coreServices.userInfo,\n      deps: {},\n      factory() {\n        return new MockUserInfoService();\n      },\n    });\n    export const mock = simpleMock(coreServices.userInfo, () => ({\n      getUserInfo: jest.fn(),\n    }));\n  }\n\n  // TODO(Rugvip): Not all core services have implementations available here yet.\n  //               some may need a bit more refactoring for it to be simpler to\n  //               re-implement functioning mock versions here.\n  export namespace cache {\n    export const factory = cacheServiceFactory;\n    export const mock = simpleMock(coreServices.cache, () => ({\n      delete: jest.fn(),\n      get: jest.fn(),\n      set: jest.fn(),\n      withOptions: jest.fn(),\n    }));\n  }\n\n  export namespace database {\n    export const factory = databaseServiceFactory;\n    export const mock = simpleMock(coreServices.database, () => ({\n      getClient: jest.fn(),\n    }));\n  }\n\n  export namespace httpRouter {\n    export const factory = httpRouterServiceFactory;\n    export const mock = simpleMock(coreServices.httpRouter, () => ({\n      use: jest.fn(),\n      addAuthPolicy: jest.fn(),\n    }));\n  }\n\n  export namespace rootHttpRouter {\n    export const factory = rootHttpRouterServiceFactory;\n    export const mock = simpleMock(coreServices.rootHttpRouter, () => ({\n      use: jest.fn(),\n    }));\n  }\n\n  export namespace lifecycle {\n    export const factory = lifecycleServiceFactory;\n    export const mock = simpleMock(coreServices.lifecycle, () => ({\n      addShutdownHook: jest.fn(),\n      addStartupHook: jest.fn(),\n    }));\n  }\n\n  export namespace logger {\n    export const factory = loggerServiceFactory;\n    export const mock = simpleMock(coreServices.logger, () => ({\n      child: jest.fn(),\n      debug: jest.fn(),\n      error: jest.fn(),\n      info: jest.fn(),\n      warn: jest.fn(),\n    }));\n  }\n\n  export namespace permissions {\n    export const factory = permissionsServiceFactory;\n    export const mock = simpleMock(coreServices.permissions, () => ({\n      authorize: jest.fn(),\n      authorizeConditional: jest.fn(),\n    }));\n  }\n\n  export namespace rootLifecycle {\n    export const factory = rootLifecycleServiceFactory;\n    export const mock = simpleMock(coreServices.rootLifecycle, () => ({\n      addShutdownHook: jest.fn(),\n      addStartupHook: jest.fn(),\n    }));\n  }\n\n  export namespace scheduler {\n    export const factory = schedulerServiceFactory;\n    export const mock = simpleMock(coreServices.scheduler, () => ({\n      createScheduledTaskRunner: jest.fn(),\n      getScheduledTasks: jest.fn(),\n      scheduleTask: jest.fn(),\n      triggerTask: jest.fn(),\n    }));\n  }\n\n  export namespace urlReader {\n    export const factory = urlReaderServiceFactory;\n    export const mock = simpleMock(coreServices.urlReader, () => ({\n      readTree: jest.fn(),\n      readUrl: jest.fn(),\n      search: jest.fn(),\n    }));\n  }\n\n  export namespace events {\n    export const factory = eventsServiceFactory;\n    export const mock = simpleMock(eventsServiceRef, () => ({\n      publish: jest.fn(),\n      subscribe: jest.fn(),\n    }));\n  }\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Backend,\n  createSpecializedBackend,\n  MiddlewareFactory,\n  createHttpServer,\n  ExtendedHttpServer,\n  HostDiscovery,\n  DefaultRootHttpRouter,\n} from '@backstage/backend-app-api';\nimport {\n  createServiceFactory,\n  BackendFeature,\n  ExtensionPoint,\n  coreServices,\n  createBackendModule,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { mockServices } from '../services';\nimport { ConfigReader } from '@backstage/config';\nimport express from 'express';\n// Direct internal import to avoid duplication\n// eslint-disable-next-line @backstage/no-forbidden-package-imports\nimport { InternalBackendFeature } from '@backstage/backend-plugin-api/src/wiring/types';\n\n/** @public */\nexport interface TestBackendOptions<TExtensionPoints extends any[]> {\n  extensionPoints?: readonly [\n    ...{\n      [index in keyof TExtensionPoints]: [\n        ExtensionPoint<TExtensionPoints[index]>,\n        Partial<TExtensionPoints[index]>,\n      ];\n    },\n  ];\n  features?: Array<\n    | BackendFeature\n    | (() => BackendFeature)\n    | Promise<{ default: BackendFeature | (() => BackendFeature) }>\n  >;\n}\n\n/** @public */\nexport interface TestBackend extends Backend {\n  /**\n   * Provides access to the underling HTTP server for use with utilities\n   * such as `supertest`.\n   *\n   * If the root http router service has been replaced, this will throw an error.\n   */\n  readonly server: ExtendedHttpServer;\n}\n\nexport const defaultServiceFactories = [\n  mockServices.auth.factory(),\n  mockServices.cache.factory(),\n  mockServices.rootConfig.factory(),\n  mockServices.database.factory(),\n  mockServices.httpAuth.factory(),\n  mockServices.httpRouter.factory(),\n  mockServices.identity.factory(),\n  mockServices.lifecycle.factory(),\n  mockServices.logger.factory(),\n  mockServices.permissions.factory(),\n  mockServices.rootLifecycle.factory(),\n  mockServices.rootLogger.factory(),\n  mockServices.scheduler.factory(),\n  mockServices.tokenManager.factory(),\n  mockServices.userInfo.factory(),\n  mockServices.urlReader.factory(),\n  mockServices.events.factory(),\n];\n\n/**\n * Given a set of features, return an array of plugins that ensures that each\n * module in the provided set of features has a corresponding plugin.\n * @internal\n */\nfunction createPluginsForOrphanModules(features: Array<BackendFeature>) {\n  const pluginIds = new Set<string>();\n  const modulePluginIds = new Set<string>();\n\n  for (const feature of features) {\n    if (isInternalBackendFeature(feature)) {\n      const registrations = feature.getRegistrations();\n      for (const registration of registrations) {\n        if (registration.type === 'plugin') {\n          pluginIds.add(registration.pluginId);\n        } else if (registration.type === 'module') {\n          modulePluginIds.add(registration.pluginId);\n        }\n      }\n    }\n  }\n\n  for (const pluginId of pluginIds) {\n    modulePluginIds.delete(pluginId);\n  }\n\n  return Array.from(modulePluginIds).map(pluginId =>\n    createBackendPlugin({\n      pluginId,\n      register(reg) {\n        reg.registerInit({ deps: {}, async init() {} });\n      },\n    }),\n  );\n}\n\n/**\n * Given a set of extension points and features, find the extension\n * points that we mock and tie them to the correct plugin ID.\n * @returns\n */\nfunction createExtensionPointTestModules(\n  features: Array<BackendFeature>,\n  extensionPointTuples?: readonly [\n    ref: ExtensionPoint<unknown>,\n    impl: unknown,\n  ][],\n): Array<() => BackendFeature> {\n  if (!extensionPointTuples) {\n    return [];\n  }\n\n  const registrations = features.flatMap(feature => {\n    if (feature.$$type !== '@backstage/BackendFeature') {\n      throw new Error(\n        `Failed to add feature, invalid type '${feature.$$type}'`,\n      );\n    }\n\n    if (isInternalBackendFeature(feature)) {\n      if (feature.version !== 'v1') {\n        throw new Error(\n          `Failed to add feature, invalid version '${feature.version}'`,\n        );\n      }\n      return feature.getRegistrations();\n    }\n    return [];\n  });\n\n  const extensionPointMap = new Map(\n    extensionPointTuples.map(ep => [ep[0].id, ep]),\n  );\n  const extensionPointsToSort = new Set(extensionPointMap.keys());\n  const extensionPointsByPlugin = new Map<string, string[]>();\n\n  for (const registration of registrations) {\n    if (registration.type === 'module') {\n      const testDep = Object.values(registration.init.deps).filter(dep =>\n        extensionPointsToSort.has(dep.id),\n      );\n      if (testDep.length > 0) {\n        let points = extensionPointsByPlugin.get(registration.pluginId);\n        if (!points) {\n          points = [];\n          extensionPointsByPlugin.set(registration.pluginId, points);\n        }\n        for (const { id } of testDep) {\n          points.push(id);\n          extensionPointsToSort.delete(id);\n        }\n      }\n    }\n  }\n\n  if (extensionPointsToSort.size > 0) {\n    const list = Array.from(extensionPointsToSort)\n      .map(id => `'${id}'`)\n      .join(', ');\n    throw new Error(\n      `Unable to determine the plugin ID of extension point(s) ${list}. ` +\n        'Tested extension points must be depended on by one or more tested modules.',\n    );\n  }\n\n  const modules = [];\n\n  for (const [pluginId, pluginExtensionPointIds] of extensionPointsByPlugin) {\n    modules.push(\n      createBackendModule({\n        pluginId,\n        moduleId: 'test-extension-point-registration',\n        register(reg) {\n          for (const id of pluginExtensionPointIds) {\n            const tuple = extensionPointMap.get(id)!;\n            reg.registerExtensionPoint(...tuple);\n          }\n\n          reg.registerInit({ deps: {}, async init() {} });\n        },\n      }),\n    );\n  }\n\n  return modules;\n}\n\nfunction isPromise<T>(value: unknown | Promise<T>): value is Promise<T> {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    'then' in value &&\n    typeof value.then === 'function'\n  );\n}\n\nfunction unwrapFeature(\n  feature: BackendFeature | (() => BackendFeature),\n): BackendFeature {\n  return typeof feature === 'function' ? feature() : feature;\n}\n\nconst backendInstancesToCleanUp = new Array<Backend>();\n\n/** @public */\nexport async function startTestBackend<TExtensionPoints extends any[]>(\n  options: TestBackendOptions<TExtensionPoints>,\n): Promise<TestBackend> {\n  const { extensionPoints, ...otherOptions } = options;\n\n  // Unpack input into awaited plain BackendFeatures\n  const features: BackendFeature[] = await Promise.all(\n    options.features?.map(async val => {\n      if (isPromise(val)) {\n        const { default: feature } = await val;\n        return unwrapFeature(feature);\n      }\n      return unwrapFeature(val);\n    }) ?? [],\n  );\n\n  let server: ExtendedHttpServer;\n\n  const rootHttpRouterFactory = createServiceFactory({\n    service: coreServices.rootHttpRouter,\n    deps: {\n      config: coreServices.rootConfig,\n      lifecycle: coreServices.rootLifecycle,\n      rootLogger: coreServices.rootLogger,\n    },\n    async factory({ config, lifecycle, rootLogger }) {\n      const router = DefaultRootHttpRouter.create();\n      const logger = rootLogger.child({ service: 'rootHttpRouter' });\n\n      const app = express();\n\n      const middleware = MiddlewareFactory.create({ config, logger });\n\n      app.use(router.handler());\n      app.use(middleware.notFound());\n      app.use(middleware.error());\n\n      server = await createHttpServer(\n        app,\n        { listen: { host: '', port: 0 } },\n        { logger },\n      );\n\n      lifecycle.addShutdownHook(() => server.stop(), { logger });\n\n      await server.start();\n\n      return router;\n    },\n  });\n\n  const discoveryFactory = createServiceFactory({\n    service: coreServices.discovery,\n    deps: {\n      rootHttpRouter: coreServices.rootHttpRouter,\n    },\n    async factory() {\n      if (!server) {\n        throw new Error('Test server not started yet');\n      }\n      const port = server.port();\n      const discovery = HostDiscovery.fromConfig(\n        new ConfigReader({\n          backend: { baseUrl: `http://localhost:${port}`, listen: { port } },\n        }),\n      );\n      return discovery;\n    },\n  });\n\n  const backend = createSpecializedBackend({\n    ...otherOptions,\n    defaultServiceFactories: [\n      ...defaultServiceFactories,\n      rootHttpRouterFactory,\n      discoveryFactory,\n    ],\n  });\n\n  backendInstancesToCleanUp.push(backend);\n\n  for (const m of createExtensionPointTestModules(features, extensionPoints)) {\n    backend.add(m);\n  }\n  for (const p of createPluginsForOrphanModules(features)) {\n    backend.add(p);\n  }\n  for (const feature of features) {\n    backend.add(feature);\n  }\n\n  await backend.start();\n\n  return Object.assign(backend, {\n    get server() {\n      if (!server) {\n        throw new Error('TestBackend server is not available');\n      }\n      return server;\n    },\n  });\n}\n\nlet registered = false;\nfunction registerTestHooks() {\n  if (typeof afterAll !== 'function') {\n    return;\n  }\n  if (registered) {\n    return;\n  }\n  registered = true;\n\n  afterAll(async () => {\n    await Promise.all(\n      backendInstancesToCleanUp.map(async backend => {\n        try {\n          await backend.stop();\n        } catch (error) {\n          console.error(`Failed to stop backend after tests, ${error}`);\n        }\n      }),\n    );\n    backendInstancesToCleanUp.length = 0;\n  });\n}\n\nregisterTestHooks();\n\nfunction isInternalBackendFeature(\n  feature: BackendFeature,\n): feature is InternalBackendFeature {\n  return (\n    typeof (feature as InternalBackendFeature).getRegistrations === 'function'\n  );\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\ninterface NodeInput<T> {\n  value: T;\n  consumes?: Iterable<string>;\n  provides?: Iterable<string>;\n}\n\n/** @internal */\nclass Node<T> {\n  static from<T>(input: NodeInput<T>) {\n    return new Node<T>(\n      input.value,\n      input.consumes ? new Set(input.consumes) : new Set(),\n      input.provides ? new Set(input.provides) : new Set(),\n    );\n  }\n\n  private constructor(\n    readonly value: T,\n    readonly consumes: Set<string>,\n    readonly provides: Set<string>,\n  ) {}\n}\n\n/** @internal */\nclass CycleKeySet<T> {\n  static from<T>(nodes: Array<Node<T>>) {\n    return new CycleKeySet<T>(nodes);\n  }\n\n  #nodeIds: Map<T, number>;\n  #cycleKeys: Set<string>;\n\n  private constructor(nodes: Array<Node<T>>) {\n    this.#nodeIds = new Map(nodes.map((n, i) => [n.value, i]));\n    this.#cycleKeys = new Set<string>();\n  }\n\n  tryAdd(path: T[]): boolean {\n    const cycleKey = this.#getCycleKey(path);\n    if (this.#cycleKeys.has(cycleKey)) {\n      return false;\n    }\n    this.#cycleKeys.add(cycleKey);\n    return true;\n  }\n\n  #getCycleKey(path: T[]): string {\n    return path\n      .map(n => this.#nodeIds.get(n)!)\n      .sort()\n      .join(',');\n  }\n}\n\n/**\n * Internal helper to help validate and traverse a dependency graph.\n * @internal\n */\nexport class DependencyGraph<T> {\n  static fromMap(\n    nodes: Record<string, Omit<NodeInput<unknown>, 'value'>>,\n  ): DependencyGraph<string> {\n    return this.fromIterable(\n      Object.entries(nodes).map(([key, node]) => ({\n        value: String(key),\n        ...node,\n      })),\n    );\n  }\n\n  static fromIterable<T>(\n    nodeInputs: Iterable<NodeInput<T>>,\n  ): DependencyGraph<T> {\n    const nodes = new Array<Node<T>>();\n    for (const nodeInput of nodeInputs) {\n      nodes.push(Node.from(nodeInput));\n    }\n\n    return new DependencyGraph(nodes);\n  }\n\n  #nodes: Array<Node<T>>;\n  #allProvided: Set<string>;\n\n  private constructor(nodes: Array<Node<T>>) {\n    this.#nodes = nodes;\n    this.#allProvided = new Set();\n\n    for (const node of this.#nodes.values()) {\n      for (const produced of node.provides) {\n        this.#allProvided.add(produced);\n      }\n    }\n  }\n\n  /**\n   * Find all nodes that consume dependencies that are not provided by any other node.\n   */\n  findUnsatisfiedDeps(): Array<{ value: T; unsatisfied: string[] }> {\n    const unsatisfiedDependencies = [];\n    for (const node of this.#nodes.values()) {\n      const unsatisfied = Array.from(node.consumes).filter(\n        id => !this.#allProvided.has(id),\n      );\n      if (unsatisfied.length > 0) {\n        unsatisfiedDependencies.push({ value: node.value, unsatisfied });\n      }\n    }\n    return unsatisfiedDependencies;\n  }\n\n  /**\n   * Detect the first circular dependency within the graph, returning the path of nodes that\n   * form a cycle, with the same node as the first and last element of the array.\n   */\n  detectCircularDependency(): T[] | undefined {\n    return this.detectCircularDependencies().next().value;\n  }\n\n  /**\n   * Detect circular dependencies within the graph, returning the path of nodes that\n   * form a cycle, with the same node as the first and last element of the array.\n   */\n  *detectCircularDependencies(): Generator<T[], undefined> {\n    const cycleKeys = CycleKeySet.from(this.#nodes);\n\n    for (const startNode of this.#nodes) {\n      const visited = new Set<Node<T>>();\n      const stack = new Array<[node: Node<T>, path: T[]]>([\n        startNode,\n        [startNode.value],\n      ]);\n\n      while (stack.length > 0) {\n        const [node, path] = stack.pop()!;\n        if (visited.has(node)) {\n          continue;\n        }\n        visited.add(node);\n        for (const consumed of node.consumes) {\n          const providerNodes = this.#nodes.filter(other =>\n            other.provides.has(consumed),\n          );\n          for (const provider of providerNodes) {\n            if (provider === startNode) {\n              if (cycleKeys.tryAdd(path)) {\n                yield [...path, startNode.value];\n              }\n\n              break;\n            }\n            if (!visited.has(provider)) {\n              stack.push([provider, [...path, provider.value]]);\n            }\n          }\n        }\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * Traverses the dependency graph in topological order, calling the provided\n   * function for each node and waiting for it to resolve.\n   *\n   * The nodes are traversed in parallel, but in such a way that no node is\n   * visited before all of its dependencies.\n   *\n   * Dependencies of nodes that are not produced by any other nodes will be ignored.\n   */\n  async parallelTopologicalTraversal<TResult>(\n    fn: (value: T) => Promise<TResult>,\n  ): Promise<TResult[]> {\n    const allProvided = this.#allProvided;\n    const producedSoFar = new Set<string>();\n    const waiting = new Set(this.#nodes.values());\n    const visited = new Set<Node<T>>();\n    const results = new Array<TResult>();\n    let inFlight = 0; // Keep track of how many callbacks are in flight, so that we know if we got stuck\n\n    // Find all nodes that have no dependencies that have not already been produced by visited nodes\n    async function processMoreNodes() {\n      if (waiting.size === 0) {\n        return;\n      }\n      const nodesToProcess = [];\n      for (const node of waiting) {\n        let ready = true;\n        for (const consumed of node.consumes) {\n          if (allProvided.has(consumed) && !producedSoFar.has(consumed)) {\n            ready = false;\n            continue;\n          }\n        }\n        if (ready) {\n          nodesToProcess.push(node);\n        }\n      }\n\n      for (const node of nodesToProcess) {\n        waiting.delete(node);\n      }\n\n      if (nodesToProcess.length === 0 && inFlight === 0) {\n        // We expect the caller to check for circular dependencies before\n        // traversal, so this error should never happen\n        throw new Error('Circular dependency detected');\n      }\n\n      await Promise.all(nodesToProcess.map(processNode));\n    }\n\n    // Process an individual node, and then add its produced dependencies to the set of available products\n    async function processNode(node: Node<T>) {\n      visited.add(node);\n      inFlight += 1;\n\n      const result = await fn(node.value);\n      results.push(result);\n\n      node.provides.forEach(produced => producedSoFar.add(produced));\n      inFlight -= 1;\n      await processMoreNodes();\n    }\n\n    await processMoreNodes();\n\n    return results;\n  }\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ServiceFactory,\n  ServiceRef,\n  coreServices,\n  createServiceFactory,\n} from '@backstage/backend-plugin-api';\nimport { ConflictError, stringifyError } from '@backstage/errors';\n// Direct internal import to avoid duplication\n// eslint-disable-next-line @backstage/no-forbidden-package-imports\nimport { InternalServiceFactory } from '@backstage/backend-plugin-api/src/services/system/types';\nimport { DependencyGraph } from '../lib/DependencyGraph';\n/**\n * Keep in sync with `@backstage/backend-plugin-api/src/services/system/types.ts`\n * @internal\n */\nexport type InternalServiceRef = ServiceRef<unknown> & {\n  __defaultFactory?: (\n    service: ServiceRef<unknown>,\n  ) => Promise<ServiceFactory | (() => ServiceFactory)>;\n};\n\nfunction toInternalServiceFactory<TService, TScope extends 'plugin' | 'root'>(\n  factory: ServiceFactory<TService, TScope>,\n): InternalServiceFactory<TService, TScope> {\n  const f = factory as InternalServiceFactory<TService, TScope>;\n  if (f.$$type !== '@backstage/BackendFeature') {\n    throw new Error(`Invalid service factory, bad type '${f.$$type}'`);\n  }\n  if (f.version !== 'v1') {\n    throw new Error(`Invalid service factory, bad version '${f.version}'`);\n  }\n  return f;\n}\n\nconst pluginMetadataServiceFactory = createServiceFactory(\n  (options?: { pluginId: string }) => ({\n    service: coreServices.pluginMetadata,\n    deps: {},\n    factory: async () => ({ getId: () => options?.pluginId! }),\n  }),\n);\n\nexport class ServiceRegistry {\n  static create(factories: Array<ServiceFactory>): ServiceRegistry {\n    const registry = new ServiceRegistry(factories);\n    registry.checkForCircularDeps();\n    return registry;\n  }\n\n  readonly #providedFactories: Map<string, InternalServiceFactory>;\n  readonly #loadedDefaultFactories: Map<\n    Function,\n    Promise<InternalServiceFactory>\n  >;\n  readonly #implementations: Map<\n    InternalServiceFactory,\n    {\n      context: Promise<unknown>;\n      byPlugin: Map<string, Promise<unknown>>;\n    }\n  >;\n  readonly #rootServiceImplementations = new Map<\n    InternalServiceFactory,\n    Promise<unknown>\n  >();\n  readonly #addedFactoryIds = new Set<string>();\n  readonly #instantiatedFactories = new Set<string>();\n\n  private constructor(factories: Array<ServiceFactory>) {\n    this.#providedFactories = new Map(\n      factories.map(sf => [sf.service.id, toInternalServiceFactory(sf)]),\n    );\n    this.#loadedDefaultFactories = new Map();\n    this.#implementations = new Map();\n  }\n\n  #resolveFactory(\n    ref: ServiceRef<unknown>,\n    pluginId: string,\n  ): Promise<InternalServiceFactory> | undefined {\n    // Special case handling of the plugin metadata service, generating a custom factory for it each time\n    if (ref.id === coreServices.pluginMetadata.id) {\n      return Promise.resolve(\n        toInternalServiceFactory(pluginMetadataServiceFactory({ pluginId })),\n      );\n    }\n\n    let resolvedFactory:\n      | Promise<InternalServiceFactory>\n      | InternalServiceFactory\n      | undefined = this.#providedFactories.get(ref.id);\n    const { __defaultFactory: defaultFactory } = ref as InternalServiceRef;\n    if (!resolvedFactory && !defaultFactory) {\n      return undefined;\n    }\n\n    if (!resolvedFactory) {\n      let loadedFactory = this.#loadedDefaultFactories.get(defaultFactory!);\n      if (!loadedFactory) {\n        loadedFactory = Promise.resolve()\n          .then(() => defaultFactory!(ref))\n          .then(f =>\n            toInternalServiceFactory(typeof f === 'function' ? f() : f),\n          );\n        this.#loadedDefaultFactories.set(defaultFactory!, loadedFactory);\n      }\n      resolvedFactory = loadedFactory.catch(error => {\n        throw new Error(\n          `Failed to instantiate service '${\n            ref.id\n          }' because the default factory loader threw an error, ${stringifyError(\n            error,\n          )}`,\n        );\n      });\n    }\n\n    return Promise.resolve(resolvedFactory);\n  }\n\n  #checkForMissingDeps(factory: InternalServiceFactory, pluginId: string) {\n    const missingDeps = Object.values(factory.deps).filter(ref => {\n      if (ref.id === coreServices.pluginMetadata.id) {\n        return false;\n      }\n      if (this.#providedFactories.get(ref.id)) {\n        return false;\n      }\n\n      return !(ref as InternalServiceRef).__defaultFactory;\n    });\n\n    if (missingDeps.length) {\n      const missing = missingDeps.map(r => `'${r.id}'`).join(', ');\n      throw new Error(\n        `Failed to instantiate service '${factory.service.id}' for '${pluginId}' because the following dependent services are missing: ${missing}`,\n      );\n    }\n  }\n\n  checkForCircularDeps(): void {\n    const graph = DependencyGraph.fromIterable(\n      Array.from(this.#providedFactories).map(\n        ([serviceId, serviceFactory]) => ({\n          value: serviceId,\n          provides: [serviceId],\n          consumes: Object.values(serviceFactory.deps).map(d => d.id),\n        }),\n      ),\n    );\n    const circularDependencies = Array.from(graph.detectCircularDependencies());\n\n    if (circularDependencies.length) {\n      const cycles = circularDependencies\n        .map(c => c.map(id => `'${id}'`).join(' -> '))\n        .join('\\n  ');\n\n      throw new ConflictError(`Circular dependencies detected:\\n  ${cycles}`);\n    }\n  }\n\n  add(factory: ServiceFactory) {\n    const factoryId = factory.service.id;\n    if (factoryId === coreServices.pluginMetadata.id) {\n      throw new Error(\n        `The ${coreServices.pluginMetadata.id} service cannot be overridden`,\n      );\n    }\n\n    if (this.#addedFactoryIds.has(factoryId)) {\n      throw new Error(\n        `Duplicate service implementations provided for ${factoryId}`,\n      );\n    }\n\n    if (this.#instantiatedFactories.has(factoryId)) {\n      throw new Error(\n        `Unable to set service factory with id ${factoryId}, service has already been instantiated`,\n      );\n    }\n\n    this.#addedFactoryIds.add(factoryId);\n    this.#providedFactories.set(factoryId, toInternalServiceFactory(factory));\n  }\n\n  async initializeEagerServicesWithScope(\n    scope: 'root' | 'plugin',\n    pluginId: string = 'root',\n  ) {\n    for (const factory of this.#providedFactories.values()) {\n      if (factory.service.scope === scope) {\n        // Root-scoped services are eager by default, plugin-scoped are lazy by default\n        if (scope === 'root' && factory.initialization !== 'lazy') {\n          await this.get(factory.service, pluginId);\n        } else if (scope === 'plugin' && factory.initialization === 'always') {\n          await this.get(factory.service, pluginId);\n        }\n      }\n    }\n  }\n\n  get<T>(ref: ServiceRef<T>, pluginId: string): Promise<T> | undefined {\n    this.#instantiatedFactories.add(ref.id);\n\n    return this.#resolveFactory(ref, pluginId)?.then(factory => {\n      if (factory.service.scope === 'root') {\n        let existing = this.#rootServiceImplementations.get(factory);\n        if (!existing) {\n          this.#checkForMissingDeps(factory, pluginId);\n          const rootDeps = new Array<Promise<[name: string, impl: unknown]>>();\n\n          for (const [name, serviceRef] of Object.entries(factory.deps)) {\n            if (serviceRef.scope !== 'root') {\n              throw new Error(\n                `Failed to instantiate 'root' scoped service '${ref.id}' because it depends on '${serviceRef.scope}' scoped service '${serviceRef.id}'.`,\n              );\n            }\n            const target = this.get(serviceRef, pluginId)!;\n            rootDeps.push(target.then(impl => [name, impl]));\n          }\n\n          existing = Promise.all(rootDeps).then(entries =>\n            factory.factory(Object.fromEntries(entries), undefined),\n          );\n          this.#rootServiceImplementations.set(factory, existing);\n        }\n        return existing as Promise<T>;\n      }\n\n      let implementation = this.#implementations.get(factory);\n      if (!implementation) {\n        this.#checkForMissingDeps(factory, pluginId);\n        const rootDeps = new Array<Promise<[name: string, impl: unknown]>>();\n\n        for (const [name, serviceRef] of Object.entries(factory.deps)) {\n          if (serviceRef.scope === 'root') {\n            const target = this.get(serviceRef, pluginId)!;\n            rootDeps.push(target.then(impl => [name, impl]));\n          }\n        }\n\n        implementation = {\n          context: Promise.all(rootDeps)\n            .then(entries =>\n              factory.createRootContext?.(Object.fromEntries(entries)),\n            )\n            .catch(error => {\n              const cause = stringifyError(error);\n              throw new Error(\n                `Failed to instantiate service '${ref.id}' because createRootContext threw an error, ${cause}`,\n              );\n            }),\n          byPlugin: new Map(),\n        };\n\n        this.#implementations.set(factory, implementation);\n      }\n\n      let result = implementation.byPlugin.get(pluginId) as Promise<any>;\n      if (!result) {\n        const allDeps = new Array<Promise<[name: string, impl: unknown]>>();\n\n        for (const [name, serviceRef] of Object.entries(factory.deps)) {\n          const target = this.get(serviceRef, pluginId)!;\n          allDeps.push(target.then(impl => [name, impl]));\n        }\n\n        result = implementation.context\n          .then(context =>\n            Promise.all(allDeps).then(entries =>\n              factory.factory(Object.fromEntries(entries), context),\n            ),\n          )\n          .catch(error => {\n            const cause = stringifyError(error);\n            throw new Error(\n              `Failed to instantiate service '${ref.id}' for '${pluginId}' because the factory function threw an error, ${cause}`,\n            );\n          });\n        implementation.byPlugin.set(pluginId, result);\n      }\n\n      return result;\n    });\n  }\n}\n","/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ServiceFactory, ServiceRef } from '@backstage/backend-plugin-api';\nimport { defaultServiceFactories } from './TestBackend';\n// Direct internal import to avoid duplication.\n// This is a relative import in order to make sure that the implementation is duplicated\n// rather than leading to an import from @backstage/backend-app-api.\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { ServiceRegistry } from '../../../../backend-app-api/src/wiring/ServiceRegistry';\n\n/**\n * Options for {@link ServiceFactoryTester}.\n * @public\n */\nexport interface ServiceFactoryTesterOptions {\n  /**\n   * Additional service factories to make available as dependencies.\n   *\n   * @remarks\n   *\n   * If a service factory is provided for a service that already has a default\n   * implementation, the provided factory will override the default.\n   */\n  dependencies?: Array<ServiceFactory | (() => ServiceFactory)>;\n}\n\n/**\n * A utility to help test service factories in isolation.\n *\n * @public\n */\nexport class ServiceFactoryTester<TService, TScope extends 'root' | 'plugin'> {\n  readonly #subject: ServiceRef<TService, TScope>;\n  readonly #registry: ServiceRegistry;\n\n  /**\n   * Creates a new {@link ServiceFactoryTester} used to test the provided subject.\n   *\n   * @param subject - The service factory to test.\n   * @param options - Additional options\n   * @returns A new tester instance for the provided subject.\n   */\n  static from<TService, TScope extends 'root' | 'plugin'>(\n    subject:\n      | ServiceFactory<TService, TScope>\n      | (() => ServiceFactory<TService, TScope>),\n    options?: ServiceFactoryTesterOptions,\n  ) {\n    const subjectFactory = typeof subject === 'function' ? subject() : subject;\n    const registry = ServiceRegistry.create([\n      ...defaultServiceFactories,\n      ...(options?.dependencies?.map(f =>\n        typeof f === 'function' ? f() : f,\n      ) ?? []),\n      subjectFactory,\n    ]);\n    return new ServiceFactoryTester(subjectFactory.service, registry);\n  }\n\n  private constructor(\n    subject: ServiceRef<TService, TScope>,\n    registry: ServiceRegistry,\n  ) {\n    this.#subject = subject;\n    this.#registry = registry;\n  }\n\n  /**\n   * Returns the service instance for the subject.\n   *\n   * @remarks\n   *\n   * If the subject is a plugin scoped service factory a plugin ID\n   * can be provided to instantiate the service for a specific plugin.\n   *\n   * By default the plugin ID 'test' is used.\n   */\n  async get(\n    ...args: 'root' extends TScope ? [] : [pluginId?: string]\n  ): Promise<TService> {\n    const [pluginId] = args;\n    return this.#registry.get(this.#subject, pluginId ?? 'test')!;\n  }\n\n  /**\n   * Return the service instance for any of the provided dependencies or built-in services.\n   *\n   * @remarks\n   *\n   * A plugin ID can optionally be provided for plugin scoped services, otherwise the plugin ID 'test' is used.\n   */\n  async getService<TGetService, TGetScope extends 'root' | 'plugin'>(\n    service: ServiceRef<TGetService, TGetScope>,\n    ...args: 'root' extends TGetScope ? [] : [pluginId?: string]\n  ): Promise<TGetService> {\n    const [pluginId] = args;\n    const instance = await this.#registry.get(service, pluginId ?? 'test');\n    if (instance === undefined) {\n      throw new Error(`Service '${service.id}' not found`);\n    }\n    return instance;\n  }\n}\n"],"names":["createConnection","uuid","__publicField","randomBytes","config","ConfigReader","DatabaseManager","dropDatabase","__privateAdd","fs","__privateGet","__privateSet","resolvePath","__privateMethod","isChildPath","dirname","path","textextensions","extname","relativePath","win32","posix","os","joinPath","mockCredentials","none","user","limitedUser","service","AuthenticationError","NotAllowedError","parseCookie","cookie","InputError","createServiceFactory","mockServices","rootConfig","coreServices","rootLogger","tokenManager","identity","auth","HostDiscovery","discovery","discoveryServiceFactory","httpAuth","userInfo","cache","cacheServiceFactory","database","databaseServiceFactory","httpRouter","httpRouterServiceFactory","rootHttpRouter","rootHttpRouterServiceFactory","lifecycle","lifecycleServiceFactory","logger","loggerServiceFactory","permissions","permissionsServiceFactory","rootLifecycle","rootLifecycleServiceFactory","scheduler","schedulerServiceFactory","urlReader","urlReaderServiceFactory","events","eventsServiceFactory","eventsServiceRef","createBackendPlugin","createBackendModule","DefaultRootHttpRouter","express","MiddlewareFactory","createHttpServer","createSpecializedBackend","ConflictError","_a","stringifyError"],"mappings":"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"}